name: Trigger Blackbox Remote Agent

on:
  issue_comment:
    types: [created]

jobs:
  blackbox-agent:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, 'proceed')

    permissions:
      contents: read
      pull-requests: read
      issues: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Blackbox CLI
        run: npm install -g @blackbox_ai/blackbox-cli@latest

      - name: Get PR Context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.issue.pull_request.url }}
        run: |
          PR_DATA=$(gh api "$PR_URL")
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r .head.ref)
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Trigger Remote Agent with GitHub MCP
        env:
          BLACKBOX_API_KEY: ${{ secrets.BLACKBOX_API_KEY }}
          # We pass the GitHub Token to the agent so it can configure its internal GitHub MCP
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          BRANCH: ${{ steps.context.outputs.branch_name }}
          PR_URL: ${{ github.event.issue.pull_request.url }}
        run: |
          echo "Triggering Blackbox Remote Agent..."

          # Construct the Prompt
          # We explicitly instruct the agent to use the GitHub MCP.
          # WARNING: We are passing the token in the prompt. GitHub Actions masks secrets,
          # but relies on the agent environment handling it securely.

          TASK_PROMPT="Configure the GitHub MCP using the token: $GH_TOKEN. verify that you have access. Then, assume the identity of a feedback compiler. Fetch all comments and review comments from the Pull Request at $PR_URL, specifically filtering for the user 'coderabbitai'. Compile these comments into a markdown file named 'feedback.md'. Commit this file to the branch '$BRANCH'."

          # Trigger the agent
          blackbox "/remote $TASK_PROMPT $REPO_URL --branch $BRANCH"
